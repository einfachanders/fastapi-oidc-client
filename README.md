# FastAPI OAuth/OIDC Client
This project aims to implement a (as close as possible) rfc-compliant OAuth/OIDC connect client using FastAPI. It was developed using Keycloak as an OpenID Provider, however theoretically any OIDC compliant OP should work (I haven't tried, but that's what standard are for, right?)  

The idea was to create a ready-to-use FastAPI template for all my projects I want to use any kind of SSO with. I tried to follow RFCs/standards whereever possible.

## ‚≠ê Features
- OAuth Confidential Client utilizing
    - OAuth Authorization Code Grant/Flow according to [RFC 6749](https://datatracker.ietf.org/doc/html/rfc6749#section-4.1) and
    - Proof Key for Code Exchange (PKCE) according to[RFC 7636](https://datatracker.ietf.org/doc/html/rfc7636) to prevent code interception attacks
    - optional OAuth State Parameter using cookies to prevent CSRF attacks
- OIDC Nonce Implementation as per [OIDC Core](https://openid.net/specs/openid-connect-core-1_0.html#AuthRequest) to mitigate replay attacks
- OIDC Backchannel Logout
- Keeping track of active sessions (either using Python in-memory storage or optionally Redis (ToDo))
- Authorization using OAuth Roles
- Pydantic Models for type checking
- Bruno API Client collection included to test endpoints
- Autogenerated OpenAPI documentation (however you should really use the bruno collection since Swagger UI can't really depict the flows in this API, at least I did not manage to get it working)
- Bruno API Client collection (Keycloak-specific)

## üîß How to run
### Baremetal (Unix-based Systems)
```bash
# Clone this repository and change working directory to backend/
git clone https://github.com/einfachanders/fastapi-oidc-client
cd fastapi-oidc-client/backend
# Create a virtual Python environment and install dependencies
python3 -m venv python-venv
source python-venv/bin/active
pip install -r requirements.txt
# copy .env.example
cp .env.example backend/.env
# IMPORTANT: Fill in env values
# run the template
uvicorn app.main:app --host 0.0.0.0
```
### Docker
ToDo

## Using this template
### Bruno Collection
The included bruno collection was written using Keycloak, os other OPs might require adjustment.

1. Import the collection from bruno/collection.json into your Bruno application
2. Change the value for `fastapi_host` to match the host where you are running this template
2. Change the default values for `keycloak_user` and `keycloak_user_password` to match a useraccount into your keycloak realm

### User Authentication/Client Authorization
1. `/api/v1/oauth`:  
Starts the OAuth Authorization code Flow
    - Sets a singed cookie `oauth_state` for tracking the state of the authentication (stores OAuth `state`, PKCE `code_verifier` and OIDC `nonce` using a JSON Web Signature)
    - Redirects the user agent to `{self.KEYCLOAK_ISSUER}/protocol/openid-connect/auth"` for authentication/authorization
    - After successful authentication the user agent is redirected to ...
2. `/api/v1/oauth/callback`:  
Processes the OPs callback
    - OPs redirect url contains `code` and `state`
    - Backend checks whether the state from the redirect url matches the state from the cookie
    - Backend calls the OPs `/token` endpoint to exchange the `code` for access, refresh and id token.
    - Backend returns access and refresh token
### Using the Access Token
- `/api/v1/protected`:  
Endpoint that can only be accessed using a valid access token. Valid means
    - the token is not expired
    - the tokens signature is valid
    - the token contains the client id of the fastapi client in its audience
    - the session referenced by the token is valid

## Known Problems
### Bruno Collection
The Bruno collection should work out-of-the-box, however the following problem have been noticed
- Bruno does not yet properly support cookie management. Therefore, after one successful run of the `oauth` folder, the cookies (especially the keycloak cookies) have to be cleared.  
If not, the `Get: Init Keycloak Auth` request will directly forward to the `api/v1/callback` endpoint, which breaks the `Post: Keycloak Auth` request.
